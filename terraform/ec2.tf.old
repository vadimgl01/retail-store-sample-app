############################################
# CONTROL PLANE NODE
############################################
resource "aws_instance" "control_plane" {
  ami                    = var.ami_id
  instance_type          = "t3.medium"
  subnet_id              = aws_subnet.public[0].id
  vpc_security_group_ids = [aws_security_group.vadim_nodes.id]
  key_name               = var.ssh_key_name
  iam_instance_profile   = aws_iam_instance_profile.ec2_profile.name

  user_data = <<EOF

aws s3 cp s3://${var.bootstrap_bucket}/kube-common.sh   /tmp/kube-common.sh
aws s3 cp s3://${var.bootstrap_bucket}/awscli_install.sh   /tmp/awscli_install.sh
aws s3 cp s3://${var.bootstrap_bucket}/control-plane.sh /tmp/control-plane.sh

chmod +x /tmp/kube-common.sh
chmod +x /tmp/control-plane.sh
chmod +x /tmp/awscli_install.sh

bash /tmp/awscli_install.sh
bash /tmp/control-plane.sh
EOF

  tags = {
    Name = "${var.project_name}-control-plane"
    Role = "control-plane"
  }
}

############################################
# WORKER NODES
############################################
resource "aws_instance" "worker_nodes" {
  count                  = var.worker_count
  ami                    = var.ami_id
  instance_type          = "t3.medium"
  subnet_id              = aws_subnet.public[count.index].id
  vpc_security_group_ids = [aws_security_group.vadim_nodes.id]
  key_name               = var.ssh_key_name
  iam_instance_profile   = aws_iam_instance_profile.ec2_profile.name

  user_data = <<EOF
#!/bin/bash -xe

aws s3 cp s3://${var.bootstrap_bucket}/awscli_install.sh   /tmp/awscli_install.sh
aws s3 cp s3://${var.bootstrap_bucket}/kube-common.sh /tmp/kube-common.sh
aws s3 cp s3://${var.bootstrap_bucket}/worker.sh      /tmp/worker.sh

chmod +x /tmp/kube-common.sh
chmod +x /tmp/worker.sh
chmod +x /tmp/awscli_install.sh

bash /tmp/awscli_install.sh
bash /tmp/worker.sh
EOF

  tags = {
    Name = "${var.project_name}-worker-${count.index + 1}"
    Role = "worker"
  }
}
