# File: .github/workflows/ci.yml
name: Build and Push Microservices to ECR

on:
  # Triggers the workflow when you push code to the 'main' branch
  push:
    branches:
      - main
    # Limits the workflow trigger to only the directories containing the microservices
    paths:
      - 'store-ui/**'
      - 'store-catalog/**'
      - 'store-cart/**'
      - 'store-orders/**'
      - 'store-checkout/**'
  
  # Allows manual triggering from the GitHub Actions UI
  workflow_dispatch:
    inputs:
      service:
        description: 'Microservice to build (e.g., store-ui)'
        required: true
        default: 'store-ui'
      tag:
        description: 'Image tag (e.g., latest, v1.0.0)'
        required: true
        default: 'latest'

env:
  # --- Variables derived from your Terraform output ---
  AWS_REGION: eu-central-1 # Your AWS Region (Frankfurt)
  AWS_ACCOUNT_ID: 630019796862 # Your AWS Account ID

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    # Define environment variables used throughout the job
    environment:
      # If triggered manually, use the input service name; otherwise, default to 'store-ui'
      # NOTE: In a multi-service repo, you would usually define a matrix job here.
      # For simplicity, we use the input/default model for testing.
      SERVICE_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.service || 'store-ui' }}
      IMAGE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.sha }}
      REPO_NAME: retail-vadim-store-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.service || 'ui' }}
      
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      # --- AWS Authentication ---
      - name: ‚öôÔ∏è Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Uses the keys you just set in your GitHub Secrets
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîê Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      # --- Docker Build & Push ---
      - name: üî® Build, Tag, and Push Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.REPO_NAME }}
          IMAGE_URL: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.REPO_NAME }}
          
        run: |
          # 1. Build the image: Context is the microservice directory, tag uses full ECR path
          echo "Building image for ${{ env.SERVICE_NAME }}"
          docker build -t ${{ env.IMAGE_URL }}:latest -t ${{ env.IMAGE_URL }}:${{ env.IMAGE_TAG }} ./${{ env.SERVICE_NAME }}

          # 2. Push the image: Pushes both the 'latest' tag and the unique git SHA tag
          echo "Pushing images to ECR: ${{ env.IMAGE_URL }}"
          docker push ${{ env.IMAGE_URL }}:latest
          docker push ${{ env.IMAGE_URL }}:${{ env.IMAGE_TAG }}
